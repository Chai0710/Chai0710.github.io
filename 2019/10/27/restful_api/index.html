
<article class="post">
    
    
        <div class="post-header main-content-wrap text-center">
    
        <h1 class="post-title">
            RESTful API
        </h1>
    
    
        <div class="post-meta">
    <time datetime="2019-10-27T00:00:00+08:00">
	
		    10月 27, 2019
    	
    </time>
    
        <span>分類 </span>
        
    <a class="category-link" href="/categories/學習日誌/">學習日誌</a>


    
</div>

    
</div>

    
    <div class="post-content markdown">
        <div class="main-content-wrap">
            <p>為了理解目前 API 設計的主流，試著整理了網路上的解說文章，作為學習筆記。</p>
<a id="more"></a>

<hr>
<h2 id="何謂-RESTful"><a href="#何謂-RESTful" class="headerlink" title="何謂 RESTful?"></a>何謂 RESTful?</h2><p>簡單來說，就是把每個網址當做資源（Resource）來看待，對同一個資源做不同的動作（HTTP Verb）會得到不同的結果。<br>符合 REST 概念設計的網址，又稱之 RESTful Route。</p>
<br>

<ul>
<li><p>REST 全名</p>
<ul>
<li>Resource : 資源</li>
<li>Representational : JSON, XML, YAML..</li>
<li>State Transfer : 狀態傳輸，透過 HTTP 動詞實現</li>
</ul>
</li>
</ul>
<ul>
<li><p>API 範例</p>
<ul>
<li>非 RESTful 的 API 可能長這樣：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/api/get_file/ ( 得到檔案 )</span><br><span class="line">/api/upload_file/ ( 新增檔案 )</span><br><span class="line">/api/update_file/ ( 更新檔案 )</span><br><span class="line">/api/delete_file/ ( 刪除檔案 )</span><br></pre></td></tr></table></figure>

<ul>
<li>RESTful API ：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/api/files/ ( GET -&gt; 得到檔案 )</span><br><span class="line">/api/files/ ( POST -&gt; 新增檔案 )</span><br><span class="line">/api/files/ ( PUT -&gt; 更新檔案)</span><br><span class="line">/api/files/ ( DELETE -&gt; 刪除檔案 )</span><br></pre></td></tr></table></figure>

</li>
</ul>
<br>

<h3 id="RESTful-Triangle"><a href="#RESTful-Triangle" class="headerlink" title="RESTful Triangle"></a>RESTful Triangle</h3><p><img src="https://image.slidesharecdn.com/asitrest-150317020843-conversion-gate01/95/learn-rest-api-at-asit-6-638.jpg?cb=1426576159" alt="相關圖片"></p>
<ol>
<li>Nouns 名詞：定義網址的 URL，每個資源僅有一個唯一的識別位置，就像家的住址。</li>
<li>Verbs 動詞：描述了對 Nouns 名詞 (資源 URL) 的操作動作，在 HTTP 1.1 的實作就是 HTTP Method。</li>
<li>Content Types 資源呈現方式：比如取得某一個 URL 文章的 HTML 格式、或者 XML 格式，同樣的 URL 資源可以有不同型態的表現方式。</li>
</ol>
<p>建議在設計 API 規格時，同時思考上述的設計原則，好讓 API 設計更接近 REST 精神。</p>
<br>

<hr>
<br>

<h2 id="RESTful-API-設計要點"><a href="#RESTful-API-設計要點" class="headerlink" title="RESTful API 設計要點"></a>RESTful API 設計要點</h2><br>

<h3 id="HTTP-動詞"><a href="#HTTP-動詞" class="headerlink" title="HTTP 動詞"></a>HTTP 動詞</h3><p>在<em>HTTP*通訊協定中制定了九種動詞</em>(Verbs)<em>來跟伺服器溝通，分別是</em>HEAD*、_GET_、_POST_、_PUT_、_PATCH_、_DELETE_、_TRACE_、_OPTIONS_、_CONNECT_。</p>
<ul>
<li>常用的 HTTP method：</li>
</ul>
<table>
<thead>
<tr>
<th align="left">HTTP</th>
<th>Method Idempotent</th>
<th>Safe</th>
</tr>
</thead>
<tbody><tr>
<td align="left">GET（讀取資源）</td>
<td>yes</td>
<td>yes</td>
</tr>
<tr>
<td align="left">HEAD（類似 GET，但只回傳 HTTP header）</td>
<td>yes</td>
<td>yes</td>
</tr>
<tr>
<td align="left">PUT （替換資源）</td>
<td>yes</td>
<td>no</td>
</tr>
<tr>
<td align="left">POST（新增資源）</td>
<td>no</td>
<td>no</td>
</tr>
<tr>
<td align="left">DELETE（刪除資源）</td>
<td>yes</td>
<td>no</td>
</tr>
<tr>
<td align="left">PATCH（更新資源部份內容）</td>
<td>no</td>
<td>no</td>
</tr>
</tbody></table>
<ul>
<li><p>Safe / Idempotent</p>
<ul>
<li><p>「safe」是指該操作不會改變伺服器端的資源狀態（而且結果可以被 cache）</p>
</li>
<li><p>「idempotent」是指該操作不管做 1 遍或做 n 遍，都會得到同樣的資源狀態結果（但不一定得到同樣的回傳值，例如第 2 次 DELETE 請求可能回傳 404），因此 client 端可以放心 retry。</p>
</li>
</ul>
</li>
</ul>
<ul>
<li><p>PUT、POST 和 PATCH 容易混淆，補充說明如下：</p>
<ol>
<li><strong>PUT</strong>通常是用來替換單一資源或資源集合 (resource collection) 的內容。</li>
<li><strong>POST</strong>除了用來新增資源，也作為 catch-all 用途，例如用在 utility API。（Utility API 是不同於一般資源讀寫操作的要求類型，例如檢查某個促銷活動碼是否有效。）</li>
<li><strong>PATCH</strong>用來更新資源部份內容。前幾年有人會用 POST 代替 PATCH，現在應該沒這必要了；建議除非 infrastructure 有限制，否則直接用 PATCH 即可。</li>
</ol>
</li>
</ul>
<br>

<h3 id="URI-名詞"><a href="#URI-名詞" class="headerlink" title="URI 名詞"></a>URI 名詞</h3><p>相對於 HTTP 動詞，URI 就是名詞了。URI 由 prefix + API endpoint 組成。Prefix 的部份可有可無，例如<code>/api</code>或<code>/api/v1</code>。API endpoint 的設計，幾個重要原則如下：</p>
<ul>
<li>一般資源用複數名詞，例如 <code>/books</code> 或 <code>/books/123</code><ul>
<li>有些人認為用單數比較好，因為<code>/book/123</code>看似比<code>/books/123</code>合理；但想想檔案系統的目錄命名（例如<code>/Users</code>或<code>/Documents</code>），其實用複數也沒問題。複數可以保持 API endpoint 的一致性，所以一般資源建議用複數。</li>
</ul>
</li>
<li>唯一資源（亦即對 client 而言只有一份的資源）用<strong>單數名詞</strong>。例如<a href="https://developer.github.com/v3/activity/watching/#list-repositories-being-watched" target="_blank" rel="noopener">GitHub watching API</a>中的<code>GET /user/subscriptions</code>，其中<code>user</code>是指目前驗證的使用者，所以用單數。</li>
<li>資源的層級架構，可以適當反應在 API endpoint 設計上，例如<code>/books/123/chapters/2</code>。</li>
<li>Utility API 與 resource API 性質不同，它的 endpoint 設計只要合理即可，例如<code>/search?q={keywords}</code>。</li>
<li>建議 URI components 都用<strong>小寫</strong>，兩個字之間用減號<code>-</code>或底線<code>_</code>隔開皆可，但應保持一致。（我個人偏好用<code>-</code>）</li>
</ul>
<br>

<h3 id="HTTP-回傳狀態碼"><a href="#HTTP-回傳狀態碼" class="headerlink" title="HTTP 回傳狀態碼"></a>HTTP 回傳狀態碼</h3><p>API 回傳的結果，應使用適當的 HTTP 狀態碼，所以 API 設計者必須了解它們。以下是一些常用的狀態碼，完整列表請參考<a href="https://en.wikipedia.org/wiki/List_of_HTTP_status_codes" target="_blank" rel="noopener">Wikipedia</a>。</p>
<ul>
<li><p>2xx: 成功</p>
<ul>
<li>200 OK: 通用狀態碼</li>
<li>201 Created: 資源新增成功</li>
<li>202 Accepted: 請求已接受，但尚在處理中</li>
<li>204 No Content: 請求成功，但未回傳任何內容</li>
</ul>
</li>
<li><p>3xx: 重新導向</p>
<ul>
<li>301 Moved Permanently: 資源已移至它處</li>
<li>303 See Other: 回傳的內容可在它處取得（例如在用戶端發送了一個 POST 請求之後）</li>
<li>304 Not Modified: 請求的資源並未修改（通常是用戶端發送了帶有 If-Modified-Since 或 If-None-Match 表頭的請求）</li>
</ul>
</li>
<li><p>4xx: 用戶端錯誤</p>
<p>（用戶端不應 retry 原始請求）</p>
<ul>
<li>400 Bad Request: 通用狀態碼</li>
<li>401 Unauthorized: 用戶端尚未驗證*</li>
<li>403 Forbidden: 用戶端被禁止此請求*</li>
<li>404 Not Found: 請求的資源不存在</li>
<li>405 Method Not Allowed: 不支援請求的 HTTP 方法</li>
<li>406 Not Acceptable: 不支援請求所<strong>要求</strong>的內容類型*（Accept 表頭）</li>
<li>415 Unsupported Media Type: 不支援請求所<strong>用</strong>的內容類型*（Content-Type 表頭）</li>
</ul>
</li>
<li><p>5xx: 伺服器錯誤</p>
<p>（用戶端可合理 retry）</p>
<ul>
<li>500 Internal Server Error: 工程師要找 bug 了</li>
<li>501 Not Implemented: 用戶端的請求目前未支援（也就是將來有可能支援）</li>
<li>502 Bad Gateway: 上游的伺服器未回傳正確結果，一般是 gateway 或 proxy server 才會回傳此狀態碼</li>
<li>503 Service Unavailable: 暫停服務（也就是過不久就會恢復服務 ── 如果一切順利的話）</li>
<li>504 Gateway Timeout: 上游的伺服器逾時，一般是 gateway 或 proxy server 才會回傳此狀態碼</li>
</ul>
</li>
</ul>
<p>* 關於幾個容易混淆的狀態碼，補充說明如下：</p>
<ol>
<li>401、403: 401 是指用戶端尚未驗證，也就是 unauthenticated（HTTP spec 裡用 unauthorized 有些誤導）；403 是指用戶端目前的身份不被允許此項請求（通常是用戶端已驗證過了），或是所有使用者都不被允許此項請求。</li>
<li>406、415: 406 是指用戶端要求「回傳」的 Content-Type（也就是用戶端在 Accept 表頭裡所要求的），伺服器不支援；415 是指用戶端送出的「請求」，其 Content-Type（也就是用戶端 HTTP request body 的內容類型），伺服器不支援。</li>
</ol>
<p>另外要注意，這些回傳的狀態碼，是代表 API 這一層的執行狀態，而<strong>不是商業邏輯</strong>這一層的狀態。例如當<code>/search?q=xyz</code>搜尋結果是空的，API 結果仍應回傳 200，而非 404；因為從 API 角度來看，<code>/search</code>這個「資源」存在，而且 API 執行成功。</p>
<br>

<h3 id="HTTP-Header"><a href="#HTTP-Header" class="headerlink" title="HTTP Header"></a>HTTP Header</h3><p>用戶端送出 API 請求時，可能會帶一些 HTTP header，例如：</p>
<ul>
<li>Accept: 能夠接受的回應內容類型 (Content-Type)，屬於內容協商的一環</li>
<li>Authorization: 認證資訊</li>
</ul>
<p>至於 API 回傳結果的 HTTP header，沒甚麼特別之處，按照一般原則處理即可（例如 Content-Type、Content-Length、ETag、Cache-Control…）。</p>
<br>

<h3 id="HTTP-Body-JSON-或-XML-格式"><a href="#HTTP-Body-JSON-或-XML-格式" class="headerlink" title="HTTP Body: JSON 或 XML 格式"></a>HTTP Body: JSON 或 XML 格式</h3><p>現在 JSON 已被普遍支援，加上 JSON 處理上較簡潔，所以越來越多人採用 JSON 作為 API 的 HTTP body 格式。但要採用 JSON 或 XML（或同時支援兩種格式），仍應視專案的實際需求而定。</p>
<br>

<h3 id="其它原則"><a href="#其它原則" class="headerlink" title="其它原則"></a>其它原則</h3><ol>
<li>與 HTTP 一樣，API 應該是 stateless，也就是一項工作單元不應由二個或二個以上 API 組成。（這也引申出一個有趣的問題：REST API 如何支援 transaction？這個問題超出本篇文章的範圍，以後有機會再談。）</li>
<li>REST API 所呈現的資源，是從應用面及 client 角度來思考，並不需要和後端的資源儲存形式（例如資料庫 schema）維持一對一的關係。</li>
<li><a href="https://en.wikipedia.org/wiki/Representational_state_transfer#Uniform_interface" target="_blank" rel="noopener">HATEOAS</a> (Hypermedia as the engine of application state) 雖然是 REST 原始定義裡的一環，但我認為不一定需要。</li>
<li>Query parameter 的部份，只要風格保持一致即可，REST 對此並無特殊規範。</li>
</ol>
<br>

<hr>
<br>

<h2 id="RESTful-架構的實踐"><a href="#RESTful-架構的實踐" class="headerlink" title="RESTful 架構的實踐"></a>RESTful 架構的實踐</h2><br>

<h3 id="HTTP"><a href="#HTTP" class="headerlink" title="HTTP"></a>HTTP</h3><p>HTTP 1.1 本身就是 REST 架構的實踐，我們可以遵循它定義好的規格，例如：</p>
<ul>
<li>透過 HTTP Status Code 回傳 API 執行結果</li>
<li>利用 HTTP Accept Header 告知 Server 指定回傳的資料格式 Content-type，JSON 可以送出 application/json、XML 可以送出 application/xml 等等</li>
<li>透過 POST 新增資料到 Server，執行成功後回傳 201 Status Code 並且透過 Location Header 告知新資源的 URL</li>
</ul>
<br>

<h3 id="優缺點"><a href="#優缺點" class="headerlink" title="優缺點"></a>優缺點</h3><ul>
<li>優點：<ul>
<li>網址更直觀，不同開發人員都遵照慣例設計網址，易於維護、擴展。</li>
<li>REST 設計將每一個實體定義獨立唯一的 URL 位置，物件資源相互的依賴性降低，API 解耦特性更好，容易彈性組合應付多數業務邏輯。</li>
</ul>
</li>
<li>缺點<ul>
<li>安全性問題，假設使用者知道 <code>/member/1</code> 是自己的會員資料，他就可以嘗試從 <code>/member/100</code> 得到其他用戶的資料，須對使用者做身份驗證。</li>
<li>資源相依結構鬆散問題，假設想要取得文章與作者資訊，就必須先 <code>GET /文章/{ID}</code> ，然後再透過取回的文章物件中的 Author 欄位再一次呼叫 <code>GET /使用者/{NAME}</code> 取得作者資訊，較為麻煩。</li>
</ul>
</li>
</ul>
<br>

<hr>
<h2 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h2><p><a href="https://railsbook.tw/chapters/11-routes.html#restful-routes" target="_blank" rel="noopener">https://railsbook.tw/chapters/11-routes.html#restful-routes</a></p>
<p><a href="https://ihower.tw/rails/restful.html" target="_blank" rel="noopener">https://ihower.tw/rails/restful.html</a></p>
<p><a href="https://tw.twincl.com/programming/*641y" target="_blank" rel="noopener">https://tw.twincl.com/programming/*641y</a></p>
<p><a href="https://github.com/twtrubiks/django-rest-framework-tutorial/tree/master/RESTful-API-Tutorial" target="_blank" rel="noopener">https://github.com/twtrubiks/django-rest-framework-tutorial/tree/master/RESTful-API-Tutorial</a></p>
<p><a href="https://www.webguide.nat.gov.tw/News_Content.aspx?n=531&amp;s=2918" target="_blank" rel="noopener">https://www.webguide.nat.gov.tw/News_Content.aspx?n=531&amp;s=2918</a></p>

            


        </div>
    </div>
    <div id="post-footer" class="post-footer main-content-wrap">
        
            <div class="post-footer-tags">
                <span class="text-color-light text-small">標籤</span><br/>
                
    <a class="tag tag--primary tag--small t-link" href="/tags/Rails/">Rails</a> <a class="tag tag--primary tag--small t-link" href="/tags/Web/">Web</a> <a class="tag tag--primary tag--small t-link" href="/tags/學習日誌/">學習日誌</a>

            </div>
        
        
            <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    <a
                        class="post-action-btn btn btn--disabled"
                        aria-hidden="true"
                    >
                        
                        <i class="fa fa-angle-left" aria-hidden="true"></i>
                        <span class="hide-xs hide-sm text-small icon-ml">上一篇</span>
                    </a>
            </li>
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2019/10/25/ruby_self/"
                    data-tooltip="Ruby Self"
                    aria-label="下一篇: Ruby Self"
                >
                    
                        <span class="hide-xs hide-sm text-small icon-mr">下一篇</span>
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                    </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a
                class="post-action-btn btn btn--default btn-open-shareoptions"
                href="#btn-open-shareoptions"
                aria-label="Share this post"
            >
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://chaichai.site/2019/10/27/restful_api/"
                    title="分享到 Facebook"
                    aria-label="分享到 Facebook"
                >
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://twitter.com/intent/tweet?text=https://chaichai.site/2019/10/27/restful_api/"
                    title="分享到 Twitter"
                    aria-label="分享到 Twitter"
                >
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://plus.google.com/share?url=https://chaichai.site/2019/10/27/restful_api/"
                    title="分享到 Google+"
                    aria-label="分享到 Google+"
                >
                    <i class="fab fa-google-plus" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="Back to top">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


        
        
            
        
    </div>
</article>


